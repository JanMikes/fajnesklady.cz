{% extends 'portal/layout.html.twig' %}

{% block title %}Audit Log - Admin{% endblock %}

{% block content %}
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Audit Log</h1>
    </div>

    {# Filters #}
    <div class="card mb-6">
        <div class="card-body p-4">
            <form method="get" class="flex flex-wrap gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Entity Type</label>
                    <select name="entity_type" class="select select-bordered select-sm">
                        <option value="">All Types</option>
                        {% for type in entityTypes %}
                            <option value="{{ type }}" {% if currentEntityType == type %}selected{% endif %}>{{ type }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Event Type</label>
                    <select name="event_type" class="select select-bordered select-sm">
                        <option value="">All Events</option>
                        {% for type in eventTypes %}
                            <option value="{{ type }}" {% if currentEventType == type %}selected{% endif %}>{{ type }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                    <input type="text" name="search" value="{{ currentSearch }}" placeholder="Entity ID or Event Type" class="input input-bordered input-sm w-64">
                </div>
                <div>
                    <button type="submit" class="btn btn-primary btn-sm">Filter</button>
                    <a href="{{ path('admin_audit_log') }}" class="btn btn-ghost btn-sm">Clear</a>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-gray-50 px-4 py-3 border-b">
            <span class="text-sm text-gray-600">Showing {{ logs|length }} of {{ totalLogs }} entries</span>
        </div>
        <div class="overflow-x-auto">
            <table class="table table-zebra text-sm">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Entity Type</th>
                        <th>Entity ID</th>
                        <th>Event Type</th>
                        <th>User</th>
                        <th>IP Address</th>
                        <th>Payload</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                        <tr>
                            <td class="text-gray-500 whitespace-nowrap">{{ log.createdAt|date('Y-m-d H:i:s') }}</td>
                            <td>
                                <span class="badge badge-outline">{{ log.entityType }}</span>
                            </td>
                            <td class="font-mono text-xs">{{ log.entityId|slice(0, 8) }}...</td>
                            <td>
                                {% set eventClass = {
                                    'order.created': 'bg-blue-100 text-blue-800',
                                    'order.paid': 'bg-green-100 text-green-800',
                                    'order.completed': 'bg-green-100 text-green-800',
                                    'order.cancelled': 'bg-red-100 text-red-800',
                                    'order.expired': 'bg-red-100 text-red-800',
                                    'contract.created': 'bg-blue-100 text-blue-800',
                                    'contract.signed': 'bg-green-100 text-green-800',
                                    'contract.terminated': 'bg-red-100 text-red-800',
                                    'storage.reserved': 'bg-yellow-100 text-yellow-800',
                                    'storage.occupied': 'bg-green-100 text-green-800',
                                    'storage.released': 'bg-gray-100 text-gray-800'
                                } %}
                                <span class="px-2 py-1 rounded text-xs font-medium {{ eventClass[log.eventType] ?? 'bg-gray-100 text-gray-800' }}">
                                    {{ log.eventType }}
                                </span>
                            </td>
                            <td>
                                {% if log.user %}
                                    <a href="{{ path('portal_users_view', {id: log.user.id}) }}" class="text-blue-600 hover:text-blue-800">
                                        {{ log.user.email }}
                                    </a>
                                {% else %}
                                    <span class="text-gray-400">System</span>
                                {% endif %}
                            </td>
                            <td class="font-mono text-xs text-gray-500">{{ log.ipAddress ?? '-' }}</td>
                            <td>
                                {% if log.payload %}
                                    <button type="button"
                                            class="text-blue-600 hover:text-blue-800 text-xs"
                                            onclick="alert(JSON.stringify({{ log.payload|json_encode }}, null, 2))">
                                        View JSON
                                    </button>
                                {% else %}
                                    <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-gray-500 py-8">No audit log entries found</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if totalPages > 1 %}
            {% include 'components/pagination.html.twig' with {
                currentPage: currentPage,
                totalPages: totalPages,
                route: 'admin_audit_log',
                routeParams: {
                    entity_type: currentEntityType,
                    event_type: currentEventType,
                    search: currentSearch
                }
            } %}
        {% endif %}
    </div>
{% endblock %}
