{% extends 'portal/layout.html.twig' %}

{% block title %}Kalendar obsazenosti{% endblock %}

{% block content %}
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Kalendar obsazenosti</h1>
    </div>

    <div class="card mb-6">
        <div class="card-body">
            <form method="get" action="{{ path('portal_calendar') }}" class="flex items-end gap-4">
                <input type="hidden" name="year" value="{{ year }}">
                <input type="hidden" name="month" value="{{ month }}">
                <div class="flex-1">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Typ skladu</label>
                    <select name="storage_type" class="select select-bordered w-full" onchange="this.form.submit()">
                        <option value="">-- Vyberte typ skladu --</option>
                        {% for storageType in storageTypes %}
                            <option value="{{ storageType.id }}" {{ selectedStorageType and selectedStorageType.id.equals(storageType.id) ? 'selected' : '' }}>
                                {{ storageType.place.name }} - {{ storageType.name }} ({{ storageType.getDimensionsInMeters() }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
    </div>

    {% if selectedStorageType %}
        <div class="card">
            <div class="card-header bg-gray-50 px-6 py-4 border-b">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <a href="{{ path('portal_calendar', {storage_type: selectedStorageType.id, year: prevYear, month: prevMonth}) }}" class="btn btn-ghost btn-sm">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </a>
                        <div class="text-center">
                            <h2 class="text-xl font-semibold text-gray-900">{{ monthName }} {{ year }}</h2>
                            <p class="text-sm text-gray-500">{{ selectedStorageType.name }} - {{ storages|length }} skladu</p>
                        </div>
                        <a href="{{ path('portal_calendar', {storage_type: selectedStorageType.id, year: nextYear, month: nextMonth}) }}" class="btn btn-ghost btn-sm">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                    </div>
                    <div class="flex items-center gap-4 text-sm">
                        <span class="flex items-center gap-1">
                            <span class="w-3 h-3 rounded-full bg-green-500"></span> Dostupne
                        </span>
                        <span class="flex items-center gap-1">
                            <span class="w-3 h-3 rounded-full bg-red-500"></span> Obsazene
                        </span>
                        <span class="flex items-center gap-1">
                            <span class="w-3 h-3 rounded-full bg-gray-400"></span> Nedostupne
                        </span>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-7 gap-1 text-center mb-2">
                    <div class="text-sm font-semibold text-gray-500 py-2">Po</div>
                    <div class="text-sm font-semibold text-gray-500 py-2">Ut</div>
                    <div class="text-sm font-semibold text-gray-500 py-2">St</div>
                    <div class="text-sm font-semibold text-gray-500 py-2">Ct</div>
                    <div class="text-sm font-semibold text-gray-500 py-2">Pa</div>
                    <div class="text-sm font-semibold text-gray-500 py-2">So</div>
                    <div class="text-sm font-semibold text-gray-500 py-2">Ne</div>
                </div>

                {% set firstDayOfMonth = date(year ~ '-' ~ month ~ '-01') %}
                {% set lastDayOfMonth = firstDayOfMonth|date_modify('last day of this month') %}
                {% set daysInMonth = lastDayOfMonth|date('j') %}
                {% set firstDayWeekday = firstDayOfMonth|date('N') %}

                <div class="grid grid-cols-7 gap-1">
                    {# Empty cells for days before the first of month #}
                    {% for i in 1..(firstDayWeekday - 1) %}
                        <div class="h-24 bg-gray-50 rounded"></div>
                    {% endfor %}

                    {# Days of the month #}
                    {% for day in 1..daysInMonth %}
                        {% set dateKey = year ~ '-' ~ (month < 10 ? '0' ~ month : month) ~ '-' ~ (day < 10 ? '0' ~ day : day) %}
                        {% set dayData = calendarData[dateKey] ?? null %}
                        {% set isToday = dateKey == 'now'|date('Y-m-d') %}

                        <div class="h-24 border rounded p-2 {{ isToday ? 'border-blue-500 border-2' : 'border-gray-200' }} hover:bg-gray-50">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-sm font-semibold {{ isToday ? 'text-blue-600' : 'text-gray-700' }}">{{ day }}</span>
                                {% if dayData %}
                                    {% set occupancyPercent = dayData.total > 0 ? ((dayData.occupied + dayData.unavailable) / dayData.total * 100)|round : 0 %}
                                    <span class="text-xs px-1.5 py-0.5 rounded {{ occupancyPercent == 100 ? 'bg-red-100 text-red-700' : (occupancyPercent > 50 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700') }}">
                                        {{ 100 - occupancyPercent }}%
                                    </span>
                                {% endif %}
                            </div>
                            {% if dayData %}
                                <div class="space-y-1 text-xs">
                                    {% if dayData.available > 0 %}
                                        <div class="flex items-center gap-1">
                                            <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                            <span class="text-green-700">{{ dayData.available }} volnych</span>
                                        </div>
                                    {% endif %}
                                    {% if dayData.occupied > 0 %}
                                        <div class="flex items-center gap-1">
                                            <span class="w-2 h-2 rounded-full bg-red-500"></span>
                                            <span class="text-red-700">{{ dayData.occupied }} obsazenych</span>
                                        </div>
                                    {% endif %}
                                    {% if dayData.unavailable > 0 %}
                                        <div class="flex items-center gap-1">
                                            <span class="w-2 h-2 rounded-full bg-gray-400"></span>
                                            <span class="text-gray-600">{{ dayData.unavailable }} blokovanych</span>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}

                    {# Empty cells for days after the last of month #}
                    {% set lastDayWeekday = lastDayOfMonth|date('N') %}
                    {% if lastDayWeekday < 7 %}
                        {% for i in (lastDayWeekday + 1)..7 %}
                            <div class="h-24 bg-gray-50 rounded"></div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        {# Storage list below calendar #}
        <div class="card mt-6">
            <div class="card-header bg-gray-50 px-6 py-4 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Prehled skladu</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="table table-zebra">
                    <thead>
                        <tr>
                            <th>Cislo</th>
                            <th>Stav</th>
                            <th>Aktualni stav</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for storage in storages %}
                            <tr>
                                <td class="font-medium text-gray-900">{{ storage.number }}</td>
                                <td>
                                    {% if storage.status.value == 'available' %}
                                        <span class="badge badge-success">Dostupny</span>
                                    {% elseif storage.status.value == 'reserved' %}
                                        <span class="badge badge-warning">Rezervovany</span>
                                    {% elseif storage.status.value == 'occupied' %}
                                        <span class="badge badge-error">Obsazeny</span>
                                    {% else %}
                                        <span class="badge badge-ghost">Nedostupny</span>
                                    {% endif %}
                                </td>
                                <td class="text-gray-500">
                                    {% if storage.isAvailable() %}
                                        Volny k pronajmu
                                    {% elseif storage.isReserved() %}
                                        Ceka na platbu
                                    {% elseif storage.isOccupied() %}
                                        Pronajaty
                                    {% else %}
                                        Rucne blokovany
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <div class="card">
            <div class="card-body text-center py-12">
                <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <h3 class="mt-4 text-lg font-medium text-gray-900">Vyberte typ skladu</h3>
                <p class="mt-2 text-sm text-gray-500">Pro zobrazeni kalendare obsazenosti vyberte typ skladu z nabidky vyse.</p>
            </div>
        </div>
    {% endif %}
{% endblock %}
