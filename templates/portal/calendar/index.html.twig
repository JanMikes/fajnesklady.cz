{% extends 'portal/layout.html.twig' %}

{% block title %}Kalendář obsazenosti{% endblock %}

{% block content %}
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">Kalendář obsazenosti</h1>
    </div>

    <div class="card mb-6">
        <div class="card-body">
            <form method="get" action="{{ path('portal_calendar') }}" class="flex flex-wrap items-end gap-4">
                <input type="hidden" name="year" value="{{ year }}">
                <input type="hidden" name="month" value="{{ month }}">
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Místo</label>
                    <select name="place" class="form-input" onchange="this.form.submit()">
                        <option value="">-- Vyberte místo --</option>
                        <option value="all" {{ selectedPlaceId == 'all' ? 'selected' : '' }}>Všechny</option>
                        {% for place in places %}
                            <option value="{{ place.id }}" {{ selectedPlace and selectedPlace.id.equals(place.id) ? 'selected' : '' }}>
                                {{ place.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Typ skladu</label>
                    <select name="storage_type" class="form-input" onchange="this.form.submit()">
                        <option value="">-- Vyberte typ skladu --</option>
                        <option value="all" {{ selectedStorageTypeId == 'all' ? 'selected' : '' }}>Všechny</option>
                        {% for storageType in storageTypes %}
                            <option value="{{ storageType.id }}" {{ selectedStorageType and selectedStorageType.id.equals(storageType.id) ? 'selected' : '' }}>
                                {{ storageType.name }} ({{ storageType.getDimensionsInMeters() }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
            <div class="card-header bg-gray-50 px-6 py-4 border-b">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <a href="{{ path('portal_calendar', {place: selectedPlaceId, storage_type: selectedStorageTypeId, year: prevYear, month: prevMonth}) }}" class="btn btn-ghost btn-sm">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                        </a>
                        <div class="text-center">
                            <h2 class="text-xl font-semibold text-gray-900">{{ monthName }} {{ year }}</h2>
                            <p class="text-sm text-gray-500">
                                {% if selectedPlace %}
                                    {{ selectedPlace.name }}
                                {% else %}
                                    Všechny místa
                                {% endif %}
                                -
                                {% if selectedStorageType %}
                                    {{ selectedStorageType.name }}
                                {% else %}
                                    Všechny typy
                                {% endif %}
                                - {{ storages|length }} skladů
                            </p>
                        </div>
                        <a href="{{ path('portal_calendar', {place: selectedPlaceId, storage_type: selectedStorageTypeId, year: nextYear, month: nextMonth}) }}" class="btn btn-ghost btn-sm">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </a>
                    </div>
                    <div class="flex items-center gap-4 text-sm">
                        <span class="flex items-center gap-1">
                            <span class="w-3 h-3 rounded-full bg-green-500"></span> Dostupné
                        </span>
                        <span class="flex items-center gap-1">
                            <span class="w-3 h-3 rounded-full bg-red-500"></span> Obsazené
                        </span>
                        <span class="flex items-center gap-1">
                            <span class="w-3 h-3 rounded-full bg-gray-400"></span> Nedostupné
                        </span>
                    </div>
                </div>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-7 gap-1 text-center mb-2">
                    <div class="text-sm font-semibold text-gray-500 py-2">Po</div>
                    <div class="text-sm font-semibold text-gray-500 py-2">Ut</div>
                    <div class="text-sm font-semibold text-gray-500 py-2">St</div>
                    <div class="text-sm font-semibold text-gray-500 py-2">Čt</div>
                    <div class="text-sm font-semibold text-gray-500 py-2">Pá</div>
                    <div class="text-sm font-semibold text-gray-500 py-2">So</div>
                    <div class="text-sm font-semibold text-gray-500 py-2">Ne</div>
                </div>

                {% set firstDayOfMonth = date(year ~ '-' ~ month ~ '-01') %}
                {% set lastDayOfMonth = firstDayOfMonth|date_modify('last day of this month') %}
                {% set daysInMonth = lastDayOfMonth|date('j') %}
                {% set firstDayWeekday = firstDayOfMonth|date('N') %}

                <div class="grid grid-cols-7 gap-1">
                    {# Empty cells for days before the first of month #}
                    {% for i in 1..(firstDayWeekday - 1) %}
                        <div class="h-24 bg-gray-50 rounded"></div>
                    {% endfor %}

                    {# Days of the month #}
                    {% for day in 1..daysInMonth %}
                        {% set dateKey = year ~ '-' ~ (month < 10 ? '0' ~ month : month) ~ '-' ~ (day < 10 ? '0' ~ day : day) %}
                        {% set dayData = calendarData[dateKey] ?? null %}
                        {% set isToday = dateKey == 'now'|date('Y-m-d') %}

                        <div class="h-24 border rounded p-2 {{ isToday ? 'border-accent border-2' : 'border-gray-200' }} hover:bg-gray-50">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-sm font-semibold {{ isToday ? 'text-accent' : 'text-gray-700' }}">{{ day }}</span>
                                {% if dayData %}
                                    {% set occupancyPercent = dayData.total > 0 ? ((dayData.occupied + dayData.unavailable) / dayData.total * 100)|round : 0 %}
                                    <span class="text-xs px-1.5 py-0.5 rounded {{ occupancyPercent == 100 ? 'bg-red-100 text-red-700' : (occupancyPercent > 50 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700') }}">
                                        {{ 100 - occupancyPercent }}%
                                    </span>
                                {% endif %}
                            </div>
                            {% if dayData %}
                                <div class="space-y-1 text-xs">
                                    {% if dayData.available > 0 %}
                                        <div class="flex items-center gap-1">
                                            <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                            <span class="text-green-700">{{ dayData.available }} volných</span>
                                        </div>
                                    {% endif %}
                                    {% if dayData.occupied > 0 %}
                                        <div class="flex items-center gap-1">
                                            <span class="w-2 h-2 rounded-full bg-red-500"></span>
                                            <span class="text-red-700">{{ dayData.occupied }} obsazených</span>
                                        </div>
                                    {% endif %}
                                    {% if dayData.unavailable > 0 %}
                                        <div class="flex items-center gap-1">
                                            <span class="w-2 h-2 rounded-full bg-gray-400"></span>
                                            <span class="text-gray-600">{{ dayData.unavailable }} blokovaných</span>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}

                    {# Empty cells for days after the last of month #}
                    {% set lastDayWeekday = lastDayOfMonth|date('N') %}
                    {% if lastDayWeekday < 7 %}
                        {% for i in (lastDayWeekday + 1)..7 %}
                            <div class="h-24 bg-gray-50 rounded"></div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        {# Storage list below calendar #}
        {% if storages|length > 0 %}
            <div class="card mt-6">
                <div class="card-header bg-gray-50 px-6 py-4 border-b">
                    <h3 class="text-lg font-semibold text-gray-900">Přehled skladů</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="table table-zebra">
                        <thead>
                            <tr>
                                <th>Číslo</th>
                                <th>Místo</th>
                                <th>Typ</th>
                                <th>Stav</th>
                                <th>Aktuální stav</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for storage in storages %}
                                <tr>
                                    <td class="font-medium text-gray-900">{{ storage.number }}</td>
                                    <td>{{ storage.place.name }}</td>
                                    <td>{{ storage.storageType.name }}</td>
                                    <td>
                                        {% if storage.status.value == 'available' %}
                                            <span class="badge badge-success">Dostupný</span>
                                        {% elseif storage.status.value == 'reserved' %}
                                            <span class="badge badge-warning">Rezervovaný</span>
                                        {% elseif storage.status.value == 'occupied' %}
                                            <span class="badge badge-error">Obsazený</span>
                                        {% else %}
                                            <span class="badge badge-ghost">Nedostupný</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-gray-500">
                                        {% if storage.isAvailable() %}
                                            Volný k pronájmu
                                        {% elseif storage.isReserved() %}
                                            Čeká na platbu
                                        {% elseif storage.isOccupied() %}
                                            Pronajatý
                                        {% else %}
                                            Ručně blokovaný
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div class="card mt-6">
                <div class="card-body text-center py-12">
                    <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                    </svg>
                    <h3 class="mt-4 text-lg font-medium text-gray-900">Žádné sklady</h3>
                    <p class="mt-2 text-sm text-gray-500">Pro vybrané filtry nebyly nalezeny žádné sklady.</p>
                </div>
            </div>
        {% endif %}
{% endblock %}
