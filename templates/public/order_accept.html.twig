{% extends app.user ? 'portal/layout.html.twig' : 'user/layout.html.twig' %}

{% block title %}Přijetí smlouvy - Fajné Sklady{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Great+Vibes&family=Pacifico&family=Satisfy&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
    {# Breadcrumb #}
    <nav class="mb-6">
        <ol class="flex items-center space-x-2 text-sm text-gray-600">
            <li><a href="{{ app.user ? path('portal_browse_places') : path('app_home') }}" class="hover:text-accent">{{ app.user ? 'Pobočky' : 'Domů' }}</a></li>
            <li><span class="mx-2">/</span></li>
            <li><a href="{{ app.user ? path('portal_browse_place_detail', {id: place.id}) : path('public_place_detail', {id: place.id}) }}" class="hover:text-accent">{{ place.name }}</a></li>
            <li><span class="mx-2">/</span></li>
            <li class="text-gray-900 font-medium">Přijetí smlouvy</li>
        </ol>
    </nav>

    <div class="max-w-2xl mx-auto"
         x-data="{
             modalOpen: false,
             signed: {{ order.hasSignature ? 'true' : 'false' }},
             acceptContract: false,
             signatureConsent: false,
         }"
         @signature:signed.window="signed = true; modalOpen = false">
        <div class="card">
            <div class="card-body">
                <h1 class="text-2xl font-bold text-gray-900 mb-6">Přijetí smluvních podmínek</h1>

                <p class="text-sm text-gray-600 mb-6">
                    Před pokračováním k platbě si prosím přečtěte a odsouhlaste smluvní podmínky pronájmu.
                </p>

                {# Order Summary #}
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h2 class="font-semibold text-gray-900 mb-3">Shrnutí objednávky</h2>

                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Pobočka</span>
                            <span class="font-medium">{{ place.name }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Adresa</span>
                            <span class="font-medium">{{ place.address }}, {{ place.city }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Skladová jednotka</span>
                            <span class="font-medium">{{ storageType.name }} - {{ storage.number }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Rozměry</span>
                            <span class="font-medium">{{ storageType.dimensionsInMeters }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Období pronájmu</span>
                            <span class="font-medium">
                                {{ order.startDate|date('d.m.Y') }}
                                -
                                {% if order.endDate %}
                                    {{ order.endDate|date('d.m.Y') }}
                                {% else %}
                                    neurčito
                                {% endif %}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Cena</span>
                            <span class="font-medium text-accent">{{ order.totalPriceInCzk|number_format(2, ',', ' ') }} Kč</span>
                        </div>
                    </div>
                </div>

                {# Contract Terms #}
                <div class="border border-gray-200 rounded-lg p-4 mb-6 max-h-64 overflow-y-auto bg-white">
                    <h3 class="font-semibold text-gray-900 mb-3">Smluvní podmínky</h3>

                    <div class="prose prose-sm text-gray-600">
                        <p><strong>1. Předmět smlouvy</strong></p>
                        <p>Pronajímatel přenechává nájemci do užívání skladovou jednotku č. {{ storage.number }}
                           v objektu {{ place.name }}, {{ place.address }}, {{ place.city }}.</p>

                        <p><strong>2. Doba pronájmu</strong></p>
                        <p>Pronájem začíná dnem {{ order.startDate|date('d.m.Y') }}
                           {% if order.endDate %}
                               a končí dnem {{ order.endDate|date('d.m.Y') }}.
                           {% else %}
                               a trvá na dobu neurčitou. Obě strany mohou smlouvu vypovědět s měsíční výpovědní lhůtou.
                           {% endif %}
                        </p>

                        <p><strong>3. Cena pronájmu</strong></p>
                        <p>Cena pronájmu činí {{ order.totalPriceInCzk|number_format(2, ',', ' ') }} Kč.</p>

                        <p><strong>4. Pravidla užívání</strong></p>
                        <ul>
                            <li>Nájemce se zavazuje užívat skladovou jednotku pouze k uskladnění vlastních věcí.</li>
                            <li>Je zakázáno skladovat hořlavé, výbušné nebo nebezpečné látky.</li>
                            <li>Je zakázáno skladovat potraviny a jiné zboží podléhající zkáze.</li>
                            <li>Nájemce má přístup ke skladové jednotce 24 hodin denně, 7 dní v týdnu.</li>
                        </ul>

                        <p><strong>5. Odpovědnost</strong></p>
                        <p>Pronajímatel nenese odpovědnost za škody způsobené vyšší mocí. Nájemce je povinen
                           uzamykat skladovou jednotku vlastním zámkem.</p>

                        <p><strong>6. Závěrečná ustanovení</strong></p>
                        <p>Přijetím těchto podmínek nájemce potvrzuje, že se seznámil s provozním řádem
                           a zavazuje se jej dodržovat.</p>
                    </div>
                </div>

                {# Signature Section #}
                <div class="border border-gray-200 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-gray-900 mb-3">Elektronický podpis</h3>

                    {# Not signed yet - show button #}
                    <div x-show="!signed">
                        <p class="text-sm text-gray-600 mb-3">
                            Pro dokončení objednávky je nutné smlouvu elektronicky podepsat.
                        </p>
                        <button type="button"
                                @click="modalOpen = true"
                                class="btn btn-secondary w-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                            Podepsat smlouvu
                        </button>
                    </div>

                    {# Signed - show confirmation #}
                    <div x-show="signed" x-cloak>
                        <div class="flex items-center gap-2 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="text-sm font-medium text-green-700">Podepsáno</span>
                        </div>
                        <div data-signature-target="preview" class="{{ order.hasSignature ? '' : 'hidden' }}">
                            <img data-signature-target="previewImage"
                                 class="max-h-20 border border-gray-200 rounded bg-white p-1"
                                 alt="Podpis"
                                 {% if order.hasSignature %}src=""{% endif %}>
                        </div>
                        <button type="button"
                                @click="modalOpen = true"
                                class="text-sm text-accent hover:underline mt-2">
                            Podepsat znovu
                        </button>
                    </div>
                </div>

                {# Signature Modal #}
                <div x-show="modalOpen"
                     x-cloak
                     class="fixed inset-0 z-50 overflow-y-auto"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0"
                     x-transition:enter-end="opacity-100"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100"
                     x-transition:leave-end="opacity-0">
                    <div class="flex items-center justify-center min-h-screen px-4">
                        {# Backdrop #}
                        <div class="fixed inset-0 bg-black bg-opacity-50" @click="modalOpen = false"></div>

                        {# Modal content #}
                        <div class="relative bg-white rounded-xl shadow-xl max-w-lg w-full p-6 z-10"
                             @click.stop
                             data-controller="signature">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-gray-900">Elektronický podpis</h3>
                                <button type="button" @click="modalOpen = false" class="text-gray-400 hover:text-gray-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>

                            {# Tabs #}
                            <div class="border-b border-gray-200 mb-4">
                                <nav class="-mb-px flex space-x-4">
                                    <button type="button"
                                            data-signature-target="drawTab"
                                            data-action="click->signature#switchToDraw"
                                            class="py-2 px-1 border-b-2 border-accent text-accent text-sm font-medium">
                                        Nakreslit
                                    </button>
                                    <button type="button"
                                            data-signature-target="typedTab"
                                            data-action="click->signature#switchToTyped"
                                            class="py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm font-medium">
                                        Napsat
                                    </button>
                                </nav>
                            </div>

                            {# Draw panel #}
                            <div data-signature-target="drawPanel">
                                <p class="text-xs text-gray-500 mb-2">Nakreslete svůj podpis do pole níže:</p>
                                <canvas data-signature-target="drawCanvas"
                                        class="w-full h-40 border border-gray-300 rounded-lg cursor-crosshair bg-white"></canvas>
                            </div>

                            {# Typed panel #}
                            <div data-signature-target="typedPanel" class="hidden">
                                <p class="text-xs text-gray-500 mb-2">Napište své jméno a vyberte styl podpisu:</p>

                                <input type="text"
                                       data-signature-target="typedInput"
                                       data-action="input->signature#onTypedInput"
                                       placeholder="Vaše jméno"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-3 focus:ring-accent focus:border-accent">

                                {# Font style buttons #}
                                <div class="grid grid-cols-2 gap-2 mb-3">
                                    <button type="button"
                                            data-action="click->signature#selectStyle"
                                            data-style-id="dancing-script"
                                            data-style-btn
                                            class="p-2 border border-gray-200 rounded-lg text-center hover:border-accent ring-2 ring-accent"
                                            style="font-family: 'Dancing Script', cursive; font-size: 18px;">
                                        Podpis
                                    </button>
                                    <button type="button"
                                            data-action="click->signature#selectStyle"
                                            data-style-id="great-vibes"
                                            data-style-btn
                                            class="p-2 border border-gray-200 rounded-lg text-center hover:border-accent"
                                            style="font-family: 'Great Vibes', cursive; font-size: 18px;">
                                        Podpis
                                    </button>
                                    <button type="button"
                                            data-action="click->signature#selectStyle"
                                            data-style-id="satisfy"
                                            data-style-btn
                                            class="p-2 border border-gray-200 rounded-lg text-center hover:border-accent"
                                            style="font-family: 'Satisfy', cursive; font-size: 18px;">
                                        Podpis
                                    </button>
                                    <button type="button"
                                            data-action="click->signature#selectStyle"
                                            data-style-id="pacifico"
                                            data-style-btn
                                            class="p-2 border border-gray-200 rounded-lg text-center hover:border-accent"
                                            style="font-family: 'Pacifico', cursive; font-size: 18px;">
                                        Podpis
                                    </button>
                                </div>

                                <canvas data-signature-target="typedCanvas"
                                        class="w-full h-24 border border-gray-300 rounded-lg bg-white"></canvas>
                            </div>

                            {# Modal footer #}
                            <div class="flex justify-between mt-4">
                                <button type="button"
                                        data-action="click->signature#clear"
                                        class="btn btn-secondary btn-sm">
                                    Vymazat
                                </button>
                                <button type="button"
                                        data-signature-target="confirmBtn"
                                        data-action="click->signature#confirm"
                                        class="btn btn-primary btn-sm">
                                    Potvrdit podpis
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                {# Accept Form #}
                <form method="post">
                    {# Hidden signature fields #}
                    <input type="hidden" name="signature_data" data-signature-target="dataField" value="">
                    <input type="hidden" name="signing_method" data-signature-target="methodField" value="">
                    <input type="hidden" name="typed_name" data-signature-target="typedNameField" value="">
                    <input type="hidden" name="style_id" data-signature-target="styleIdField" value="">

                    <div class="space-y-4 mb-6">
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox"
                                   name="accept_contract"
                                   value="1"
                                   x-model="acceptContract"
                                   class="mt-1 mr-3 h-4 w-4 text-accent border-gray-300 rounded focus:ring-accent">
                            <span class="text-sm text-gray-700">
                                Souhlasím se smluvními podmínkami a potvrzuji, že jsem si přečetl/a
                                všechny informace o pronájmu skladové jednotky.
                            </span>
                        </label>

                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox"
                                   name="signature_consent"
                                   value="1"
                                   x-model="signatureConsent"
                                   class="mt-1 mr-3 h-4 w-4 text-accent border-gray-300 rounded focus:ring-accent">
                            <span class="text-sm text-gray-700">
                                Souhlasím s použitím elektronického podpisu a potvrzuji, že podpis je platný
                                a závazný.
                            </span>
                        </label>
                    </div>

                    <button type="submit"
                            class="btn btn-primary btn-lg w-full"
                            :disabled="!(signed && acceptContract && signatureConsent)"
                            :class="{'opacity-50 cursor-not-allowed': !(signed && acceptContract && signatureConsent)}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Souhlasím a pokračuji k platbě
                    </button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
